<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head('MovieBook - Manage Theaters')}"></head>
<body class="bg-light">
<nav th:replace="~{fragments/header :: navbar}"></nav>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-2">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white"><h6 class="mb-0"><i class="fas fa-cog me-1"></i>Admin Panel</h6></div>
                <div class="list-group list-group-flush">
                    <a href="/admin" class="list-group-item list-group-item-action"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
                    <a href="/admin/movies" class="list-group-item list-group-item-action"><i class="fas fa-film me-2"></i>Movies</a>
                    <a href="/admin/theaters" class="list-group-item list-group-item-action active"><i class="fas fa-building me-2"></i>Theaters</a>
                    <a href="/admin/showtimes" class="list-group-item list-group-item-action"><i class="fas fa-calendar me-2"></i>Showtimes</a>
                    <a href="/admin/users" class="list-group-item list-group-item-action"><i class="fas fa-users me-2"></i>Users</a>
                </div>
            </div>
        </div>

        <div class="col-md-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="fas fa-building me-2"></i>Manage Theaters</h3>
                <button class="btn btn-success" onclick="toggleForm()"><i class="fas fa-plus me-1"></i>Add Theater</button>
            </div>

            <!-- Add Form -->
            <div id="theaterForm" class="card shadow-sm mb-4 d-none">
                <div class="card-header"><h6 class="mb-0">Add Theater (uses Abstract Factory pattern)</h6></div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6"><label class="form-label">Name</label><input class="form-control" id="tName"></div>
                        <div class="col-md-3"><label class="form-label">Theater Type</label>
                            <select class="form-select" id="tType">
                                <option value="REGULAR">Regular</option>
                                <option value="IMAX">IMAX</option>
                                <option value="FOUR_DX">4DX</option>
                            </select>
                        </div>
                        <div class="col-md-3"><label class="form-label">Screens</label><input type="number" class="form-control" id="tScreens" value="2"></div>
                        <div class="col-md-6"><label class="form-label">Location</label><input class="form-control" id="tLocation"></div>
                        <div class="col-md-3"><label class="form-label">City</label><input class="form-control" id="tCity" value="Bangalore"></div>
                        <div class="col-md-3"><label class="form-label">State</label><input class="form-control" id="tState" value="Karnataka"></div>
                        <div class="col-md-3"><label class="form-label">Pincode</label><input class="form-control" id="tPin" value="560001"></div>
                        <div class="col-md-9"><label class="form-label">Facilities</label><input class="form-control" id="tFacilities" placeholder="Parking, Food Court, etc."></div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-success" onclick="createTheater()">Create Theater</button>
                        <button class="btn btn-secondary" onclick="toggleForm()">Cancel</button>
                    </div>
                    <div class="alert alert-info mt-3">
                        <small><strong>Abstract Factory Pattern:</strong> Based on the theater type selected, different screen configurations and seat layouts will be auto-generated.
                        <br>Regular: 10x15 seats, Dolby 5.1 | IMAX: 12x20 seats, Dolby Atmos 12.1 | 4DX: 8x12 motion seats</small>
                    </div>
                </div>
            </div>

            <!-- Theaters List -->
            <div id="theatersList">
                <div class="text-center py-5"><div class="spinner-border text-primary"></div></div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>
<script>
const token = localStorage.getItem('accessToken');
if (!token) { window.location.href = '/login'; }

function toggleForm() { document.getElementById('theaterForm').classList.toggle('d-none'); }

async function loadTheaters() {
    const res = await fetch('/api/admin/theaters', { headers: { 'Authorization': 'Bearer ' + token }});
    const data = await res.json();
    if (data.success) {
        document.getElementById('theatersList').innerHTML = data.data.map(t => `
            <div class="card shadow-sm mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">${t.name}</h5>
                            <p class="text-muted mb-1"><i class="fas fa-map-marker-alt me-1"></i>${t.location}, ${t.city}</p>
                            <span class="badge bg-${t.theaterType === 'IMAX' ? 'primary' : t.theaterType === 'FOUR_DX' ? 'danger' : 'secondary'}">${t.theaterType}</span>
                            <span class="badge bg-info">${t.totalScreens} screens</span>
                            ${t.isActive ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-danger">Inactive</span>'}
                        </div>
                        <a href="#" onclick="viewTheater(${t.id})" class="btn btn-outline-primary btn-sm">View Details</a>
                    </div>
                </div>
            </div>
        `).join('');
    }
}

async function viewTheater(id) {
    const res = await fetch(`/api/admin/theaters/${id}`, { headers: { 'Authorization': 'Bearer ' + token }});
    const data = await res.json();
    if (data.success) {
        const t = data.data;
        const screens = t.screens ? t.screens.map(s => `
            <tr><td>${s.screenName}</td><td>${s.screenType}</td><td>${s.totalSeats}</td><td>${s.rows}x${s.columns}</td><td>${s.soundSystem}</td><td>${s.screenSize}</td></tr>
        `).join('') : '<tr><td colspan="6">No screens</td></tr>';
        alert(`Theater: ${t.name}\nType: ${t.theaterType}\nScreens: ${t.totalScreens}\nFacilities: ${t.facilities || 'N/A'}\n\n(Screen details in console)`);
        console.table(t.screens);
    }
}

async function createTheater() {
    const body = {
        name: document.getElementById('tName').value,
        theaterType: document.getElementById('tType').value,
        totalScreens: parseInt(document.getElementById('tScreens').value),
        location: document.getElementById('tLocation').value,
        city: document.getElementById('tCity').value,
        state: document.getElementById('tState').value,
        pincode: document.getElementById('tPin').value,
        facilities: document.getElementById('tFacilities').value
    };

    const res = await fetch('/api/admin/theaters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.success) { toggleForm(); loadTheaters(); alert('Theater created with auto-generated screens and seats!'); }
    else { alert(data.message); }
}

loadTheaters();
</script>
</body>
</html>
