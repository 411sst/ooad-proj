<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head('MovieBook - Select Seats')}"></head>
<body class="bg-light">
<nav th:replace="~{fragments/header :: navbar}"></nav>

<div class="container py-4">
    <div class="row">
        <!-- Seat Map -->
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-chair me-2"></i>Select Your Seats</h5>
                </div>
                <div class="card-body text-center">
                    <div id="movieInfo" class="mb-3"></div>
                    <div class="screen-label">SCREEN</div>
                    <div class="screen"></div>
                    <div id="seatMap" class="seat-map"></div>
                    <div class="mt-3 d-flex justify-content-center gap-3">
                        <span><span class="badge bg-success">&nbsp;&nbsp;</span> Available</span>
                        <span><span class="badge bg-primary">&nbsp;&nbsp;</span> Selected</span>
                        <span><span class="badge bg-warning text-dark">&nbsp;&nbsp;</span> Locked</span>
                        <span><span class="badge bg-danger">&nbsp;&nbsp;</span> Booked</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Summary -->
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Booking Summary</h5>
                </div>
                <div class="card-body">
                    <div id="selectedSeatsInfo">
                        <p class="text-muted">Select seats from the map</p>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>Selected:</strong>
                        <span id="seatCount">0 seats</span>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <strong>Total:</strong>
                        <span id="totalPrice" class="fw-bold text-success fs-5">₹0</span>
                    </div>
                    <hr>
                    <div id="lockTimer" class="text-center text-danger d-none mb-3">
                        <i class="fas fa-clock me-1"></i>Lock expires in: <span id="timerDisplay">10:00</span>
                    </div>
                    <button id="proceedBtn" class="btn btn-primary w-100" disabled onclick="proceedToBooking()">
                        Proceed to Food & Beverages
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
const showtimeId = window.location.pathname.split('/').pop();
const token = localStorage.getItem('accessToken');
let selectedSeats = [];
let seatData = {};
let stompClient = null;
let lockTimer = null;

if (!token) { window.location.href = '/login'; }

// Load seat map
async function loadSeatMap() {
    const res = await fetch(`/api/seats/showtime/${showtimeId}`, {
        headers: { 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json();
    if (data.success) renderSeatMap(data.data);
}

function renderSeatMap(mapData) {
    document.getElementById('movieInfo').innerHTML =
        `<h6>${mapData.screenName} | ${mapData.availableSeats}/${mapData.totalSeats} seats available</h6>`;

    const container = document.getElementById('seatMap');
    container.innerHTML = '';

    const seats = mapData.seats;
    const rows = {};
    seats.forEach(s => {
        seatData[s.id] = s;
        if (!rows[s.row]) rows[s.row] = [];
        rows[s.row].push(s);
    });

    Object.keys(rows).sort().forEach(row => {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'seat-row';

        const label = document.createElement('span');
        label.className = 'me-2 fw-bold';
        label.style.width = '20px';
        label.textContent = row;
        rowDiv.appendChild(label);

        rows[row].sort((a,b) => a.number - b.number).forEach(seat => {
            const btn = document.createElement('div');
            btn.className = 'seat ' + seat.status.toLowerCase();
            btn.id = 'seat-' + seat.id;
            btn.textContent = seat.number;
            btn.title = `${seat.label} - ${seat.type} - ₹${seat.price}`;
            if (seat.status === 'AVAILABLE') {
                btn.onclick = () => toggleSeat(seat);
            }
            rowDiv.appendChild(btn);
        });

        container.appendChild(rowDiv);
    });
}

function toggleSeat(seat) {
    const idx = selectedSeats.findIndex(s => s.id === seat.id);
    const el = document.getElementById('seat-' + seat.id);
    if (idx >= 0) {
        selectedSeats.splice(idx, 1);
        el.className = 'seat available';
    } else {
        if (selectedSeats.length >= 10) { alert('Maximum 10 seats allowed'); return; }
        selectedSeats.push(seat);
        el.className = 'seat selected';
    }
    updateSummary();
}

function updateSummary() {
    const count = selectedSeats.length;
    const total = selectedSeats.reduce((sum, s) => sum + parseFloat(s.price), 0);
    document.getElementById('seatCount').textContent = count + ' seat(s)';
    document.getElementById('totalPrice').textContent = '₹' + total.toFixed(2);
    document.getElementById('proceedBtn').disabled = count === 0;

    const info = document.getElementById('selectedSeatsInfo');
    if (count > 0) {
        info.innerHTML = selectedSeats.map(s =>
            `<div class="d-flex justify-content-between"><span>${s.label} (${s.type})</span><span>₹${s.price}</span></div>`
        ).join('');
    } else {
        info.innerHTML = '<p class="text-muted">Select seats from the map</p>';
    }
}

async function proceedToBooking() {
    const btn = document.getElementById('proceedBtn');
    btn.disabled = true;
    btn.textContent = 'Creating booking...';

    try {
        const res = await fetch('/api/bookings/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ showtimeId: parseInt(showtimeId), seatIds: selectedSeats.map(s => s.id) })
        });
        const data = await res.json();
        if (data.success) {
            window.location.href = '/food/' + data.data.id;
        } else {
            alert(data.message);
            btn.disabled = false;
            btn.textContent = 'Proceed to Food & Beverages';
        }
    } catch(e) {
        alert('Error creating booking');
        btn.disabled = false;
        btn.textContent = 'Proceed to Food & Beverages';
    }
}

// WebSocket for real-time updates
function connectWebSocket() {
    const socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);
    stompClient.debug = null; // Disable debug logs
    stompClient.connect({}, function() {
        stompClient.subscribe('/topic/seats/' + showtimeId, function(message) {
            const event = JSON.parse(message.body);
            event.updatedSeats.forEach(update => {
                const el = document.getElementById('seat-' + update.seatId);
                if (el && !selectedSeats.find(s => s.id === update.seatId)) {
                    el.className = 'seat ' + update.status.toLowerCase();
                    if (update.status === 'AVAILABLE') {
                        el.onclick = () => toggleSeat(seatData[update.seatId]);
                    } else {
                        el.onclick = null;
                    }
                }
            });
        });
    });
}

loadSeatMap();
connectWebSocket();
</script>
</body>
</html>
