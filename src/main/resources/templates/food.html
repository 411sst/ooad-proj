<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head('MovieBook - Food & Beverages')}"></head>
<body class="bg-light">
<nav th:replace="~{fragments/header :: navbar}"></nav>

<div class="container py-4">
    <div class="row">
        <!-- Menu -->
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-utensils me-2"></i>Food & Beverages</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" id="foodTabs">
                        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#all">All</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#popcorn">Popcorn</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#beverages">Beverages</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#snacks">Snacks</a></li>
                        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#combos">Combos</a></li>
                    </ul>
                    <div id="menuItems" class="row g-3"></div>
                </div>
            </div>
        </div>

        <!-- Cart Summary -->
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Order Summary</h5>
                </div>
                <div class="card-body">
                    <div id="bookingInfo" class="mb-3"></div>
                    <hr>
                    <div id="cartItems"><p class="text-muted">No food items added</p></div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span>Ticket Amount:</span>
                        <span id="ticketAmount">₹0</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Food Amount:</span>
                        <span id="foodAmountDisplay">₹0</span>
                    </div>
                    <div class="d-flex justify-content-between fw-bold mt-2 fs-5">
                        <span>Subtotal:</span>
                        <span id="subtotal" class="text-success">₹0</span>
                    </div>
                    <button class="btn btn-success w-100 mt-3" onclick="proceedToPayment()">
                        Proceed to Payment <i class="fas fa-arrow-right ms-1"></i>
                    </button>
                    <button class="btn btn-outline-secondary w-100 mt-2" onclick="skipFood()">
                        Skip Food & Go to Payment
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>
<script>
const bookingId = window.location.pathname.split('/').pop();
const token = localStorage.getItem('accessToken');
let menuData = [];
let cart = {}; // foodItemId -> quantity
let bookingData = null;

if (!token) { window.location.href = '/login'; }

async function loadData() {
    const [menuRes, bookingRes] = await Promise.all([
        fetch('/api/food/menu', { headers: { 'Authorization': 'Bearer ' + token }}),
        fetch(`/api/bookings/${bookingId}`, { headers: { 'Authorization': 'Bearer ' + token }})
    ]);
    const menu = await menuRes.json();
    const booking = await bookingRes.json();

    if (menu.success) { menuData = menu.data; renderMenu('ALL'); }
    if (booking.success) {
        bookingData = booking.data;
        document.getElementById('bookingInfo').innerHTML =
            `<strong>${bookingData.movieTitle}</strong><br><small>${bookingData.seatLabels.join(', ')} | ${bookingData.numSeats} seat(s)</small>`;
        document.getElementById('ticketAmount').textContent = '₹' + bookingData.ticketAmount;
        updateCart();
    }
}

function renderMenu(filter) {
    const container = document.getElementById('menuItems');
    const items = filter === 'ALL' ? menuData : menuData.filter(i => i.category === filter);

    container.innerHTML = items.map(item => `
        <div class="col-md-6">
            <div class="food-card p-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${item.name}${item.isVegetarian ? ' <span class="badge bg-success">Veg</span>' : ' <span class="badge bg-danger">Non-Veg</span>'}</h6>
                        <small class="text-muted">${item.description || ''}</small>
                        <div class="fw-bold mt-1">₹${item.price}</div>
                    </div>
                    <div class="quantity-controls">
                        <button class="btn btn-outline-secondary btn-sm" onclick="changeQty(${item.id}, -1)">-</button>
                        <span id="qty-${item.id}" class="fw-bold">${cart[item.id] || 0}</span>
                        <button class="btn btn-outline-primary btn-sm" onclick="changeQty(${item.id}, 1)">+</button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function changeQty(itemId, delta) {
    cart[itemId] = Math.max(0, (cart[itemId] || 0) + delta);
    if (cart[itemId] === 0) delete cart[itemId];
    document.getElementById('qty-' + itemId).textContent = cart[itemId] || 0;
    updateCart();
}

function updateCart() {
    const cartDiv = document.getElementById('cartItems');
    const entries = Object.entries(cart);
    let foodTotal = 0;

    if (entries.length === 0) {
        cartDiv.innerHTML = '<p class="text-muted">No food items added</p>';
    } else {
        cartDiv.innerHTML = entries.map(([id, qty]) => {
            const item = menuData.find(m => m.id == id);
            const sub = item.price * qty;
            foodTotal += sub;
            return `<div class="d-flex justify-content-between"><span>${item.name} x${qty}</span><span>₹${sub}</span></div>`;
        }).join('');
    }

    document.getElementById('foodAmountDisplay').textContent = '₹' + foodTotal.toFixed(2);
    const ticket = bookingData ? parseFloat(bookingData.ticketAmount) : 0;
    document.getElementById('subtotal').textContent = '₹' + (ticket + foodTotal).toFixed(2);
}

async function proceedToPayment() {
    if (Object.keys(cart).length > 0) {
        await fetch('/api/food/order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ bookingId: parseInt(bookingId), items: cart })
        });
    }
    window.location.href = '/payment/' + bookingId;
}

function skipFood() { window.location.href = '/payment/' + bookingId; }

// Tab filtering
document.querySelectorAll('#foodTabs .nav-link').forEach(tab => {
    tab.addEventListener('click', () => {
        const filter = tab.textContent.trim().toUpperCase();
        const map = { 'ALL': 'ALL', 'POPCORN': 'POPCORN', 'BEVERAGES': 'BEVERAGE', 'SNACKS': 'SNACK', 'COMBOS': 'COMBO' };
        renderMenu(map[filter] || 'ALL');
    });
});

loadData();
</script>
</body>
</html>
